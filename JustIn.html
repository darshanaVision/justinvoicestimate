<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Invoice / Estimate</title>
  <style>
    :root {
      --accent: #0b74de;
      --muted: #666;
      --error: #e74c3c;
    }
    
    body {
      font-family: Inter, Segoe UI, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      background: #f5f7fb;
      color: #111;
    }
    
    .app {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    
    @media (min-width: 900px) {
      .app {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 18px;
      }
    }
    
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(10, 20, 30, 0.06);
    }
    
    h1 {
      margin: 6px 0 18px;
    }
    
    h2 {
      margin: 6px 0 12px;
      font-size: 18px;
    }
    
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin: 6px 0 6px;
    }
    
    input[type="text"],
    input[type="number"],
    textarea,
    select,
    input[type="datetime-local"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #e3e6ee;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .logo-preview {
      height: 70px;
      width: 100%;
      max-width: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px dashed #ddd;
      border-radius: 6px;
      background: #fafbff;
      overflow: hidden;
      cursor: pointer;
    }
    
    .logo-preview img {
      max-height: 68px;
      max-width: 100%;
    }
    
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .row > * {
      flex: 1;
      min-width: 120px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #f0f1f6;
      text-align: left;
    }
    
    th {
      font-size: 13px;
      color: var(--muted);
    }
    
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    
    .btn {
      display: inline-block;
      padding: 8px 10px;
      border-radius: 8px;
      border: 0;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid #e3e6ee;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .preview-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .iframe-wrap {
      height: 720px;
      border: 1px solid #e3e6ee;
      border-radius: 8px;
      overflow: hidden;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }
    
    .totals {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      margin-top: 8px;
    }
    
    .small {
      font-size: 13px;
    }
    
    .danger {
      color: #c0392b;
    }
    
    .center {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: #2ecc71;
      color: white;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .example-text {
      color: #aaa;
      font-size: 12px;
      margin-top: 4px;
    }
    
    .no-items {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }
    
    .validation-error {
      border: 1px solid var(--error) !important;
    }
    
    .error-message {
      color: var(--error);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .items-table-container {
      overflow: visible;
      margin-top: 10px;
    }
    
    .items-table-wrapper {
      overflow-x: auto;
      width: 100%;
    }
    
    .items-table-wrapper table {
      min-width: 600px;
    }
    
    .example-value {
      color: #999;
      font-style: italic;
    }
  </style>
  <!-- Include jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div style="max-width:1200px;margin:0 auto">
    <h1 style="margin:6px 0 18px">Simple Invoice / Estimate</h1>
    <div class="app">
      <div class="card">
        <h2>Settings</h2>
        <label>Type</label>
        <select id="type">
          <option value="invoice">Invoice</option>
          <option value="estimate">Estimate</option>
        </select>

        <label>Logo (upload)</label>
        <div class="logo-preview" id="logoPreview">Drop or select logo</div>
        <input type="file" id="logoInput" accept="image/*" style="margin-top:8px;display:none" />

        <label>From / Seller address <span style="color:var(--error)">*</span></label>
        <textarea id="fromAddress" rows="3" placeholder="Example:
Your Company Name
123 Business Street
City, State 12345
Email: contact@company.com
Phone: (123) 456-7890"></textarea>
        <div class="example-text">Enter your company address and contact information</div>
        <div id="fromAddressError" class="error-message" style="display:none">Please fill in the sender address</div>

        <label>To / Client address <span style="color:var(--error)">*</span></label>
        <textarea id="toAddress" rows="3" placeholder="Example:
Client Company Name
456 Client Avenue
City, State 67890
Attn: John Smith
Email: john@client.com"></textarea>
        <div class="example-text">Enter your client's address and contact information</div>
        <div id="toAddressError" class="error-message" style="display:none">Please fill in the recipient address</div>

        <label>Currency & Format</label>
        <div class="row">
          <select id="currency">
            <option value="USD">USD - $</option>
            <option value="EUR">EUR - €</option>
            <option value="GBP">GBP - £</option>
            <option value="JPY">JPY - ¥</option>
            <option value="CAD">CAD - C$</option>
            <option value="AUD">AUD - A$</option>
            <option value="CHF">CHF - CHF</option>
            <option value="CNY">CNY - ¥</option>
            <option value="INR">INR - ₹</option>
            <option value="LKR">LKR - Rs</option>
            <option value="BRL">BRL - R$</option>
            <option value="RUB">RUB - ₽</option>
            <option value="MXN">MXN - $</option>
            <option value="SGD">SGD - S$</option>
            <option value="NZD">NZD - NZ$</option>
            <option value="SEK">SEK - kr</option>
            <option value="NOK">NOK - kr</option>
            <option value="DKK">DKK - kr</option>
            <option value="ZAR">ZAR - R</option>
            <option value="AED">AED - د.إ</option>
          </select>
          <select id="currencyPos">
            <option value="prefix">Symbol before</option>
            <option value="suffix">Symbol after</option>
          </select>
        </div>

        <label>Invoice / Estimate Number</label>
        <input id="number" type="text" value="INV-001" />

        <label>Date & Time</label>
        <input id="date" type="datetime-local" />

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="addItemBtn">+ Add item</button>
        </div>

        <h2 style="margin-top:14px">Items / Services <span style="color:var(--error)">*</span></h2>
        <div id="itemsError" class="error-message" style="display:none">Please add at least one item with description, quantity and price</div>
        <div class="items-table-container">
          <div id="noItemsMessage" class="no-items">No items added yet. Click "Add item" to get started.</div>
          <div class="items-table-wrapper">
            <table id="itemsTable">
              <thead>
                <tr>
                  <th style="width:40%">Description</th>
                  <th>Unit Price </th>
                  <th>Number of units <span class="example-text">(hr,Kg,...)</span></th>
                  <th>Price </th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="margin:0">Tax (%)</label>
          <input id="tax" type="number" value="0" style="width:90px" />
          <label style="margin:0">Discount (%)</label>
          <input id="discount" type="number" value="0" style="width:90px" />
        </div>

      </div>

      <div class="preview-wrap">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="muted">Live Preview</div>
          <button class="btn" id="downloadPdfBtn" disabled>Download as PDF</button>
        </div>

        <div class="iframe-wrap card">
          <iframe id="previewFrame" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
      </div>
    </div>

    <p class="muted small" style="margin-top:10px">Notes: The preview is rendered inside an isolated iframe (sandboxed).</p>
  </div>

  <div id="statusMessage" class="status"></div>

  <script>
    // Simple invoice app logic
    const items = [];
    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');
    const itemsTableBody = document.querySelector('#itemsTable tbody');
    const addItemBtn = document.getElementById('addItemBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const previewFrame = document.getElementById('previewFrame');
    const statusMessage = document.getElementById('statusMessage');
    const noItemsMessage = document.getElementById('noItemsMessage');
    const fromAddressError = document.getElementById('fromAddressError');
    const toAddressError = document.getElementById('toAddressError');
    const itemsError = document.getElementById('itemsError');

    // Set up real-time event listeners for all inputs
    const watchedElements = [
      'type', 'fromAddress', 'toAddress', 'currency', 'currencyPos', 
      'number', 'date', 'tax', 'discount'
    ];

    // Set default date to now
    const dateInput = document.getElementById('date');
    (function setNow(){
      const now = new Date();
      // format as yyyy-mm-ddThh:mm
      const iso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      dateInput.value = iso;
    })();

    // Add event listeners for real-time updates
    watchedElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', function() {
          generatePreview();
          validateForm();
        });
        element.addEventListener('change', function() {
          generatePreview();
          validateForm();
        });
      }
    });

    let logoDataUrl = '';
    logoInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        logoDataUrl = reader.result;
        renderLogo();
        generatePreview();
      }
      reader.readAsDataURL(f);
    });

    logoPreview.addEventListener('click', ()=> logoInput.click());
    logoPreview.addEventListener('dragover', e=>{e.preventDefault();logoPreview.style.background='#eef'});
    logoPreview.addEventListener('dragleave', e=>{e.preventDefault();logoPreview.style.background=''});
    logoPreview.addEventListener('drop', e=>{
      e.preventDefault();
      const f = e.dataTransfer.files[0];
      if(!f) return;
      logoInput.files = e.dataTransfer.files;
      const reader = new FileReader();
      reader.onload = ()=>{logoDataUrl = reader.result;renderLogo();generatePreview()}
      reader.readAsDataURL(f);
    });

    function renderLogo(){
      logoPreview.innerHTML = '';
      if(logoDataUrl){
        const img = document.createElement('img'); 
        img.src = logoDataUrl; 
        logoPreview.appendChild(img);
      } else {
        logoPreview.textContent = 'Drop or select logo';
      }
    }

    function addItem(desc='', unitPrice='', numberOfUnits='', unitType=''){
      const id = Date.now() + Math.random();
      const price = (parseFloat(unitPrice) || 0) * (parseFloat(numberOfUnits) || 0);
      items.push({id, desc, unitPrice, numberOfUnits, unitType, price});
      refreshItemsTable();
      generatePreview();
      validateForm();
    }

    function refreshItemsTable(){
      itemsTableBody.innerHTML = '';
      
      // Show/hide no items message
      if (items.length === 0) {
        noItemsMessage.style.display = 'block';
        itemsTableBody.style.display = 'none';
      } else {
        noItemsMessage.style.display = 'none';
        itemsTableBody.style.display = 'table-row-group';
        
        items.forEach(it=>{
          const calculatedPrice = (parseFloat(it.unitPrice) || 0) * (parseFloat(it.numberOfUnits) || 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input data-id="${it.id}" class="desc" value="${escapeHtml(it.desc)}" placeholder="Web Design Service"/></td>
            <td><input data-id="${it.id}" class="unitPrice" type="number" min="0" step="0.01" value="${it.unitPrice}" placeholder="$75.00" style="width:100px"/></td>
            <td>
              <div style="display:flex;gap:4px;align-items:center">
                <input data-id="${it.id}" class="numberOfUnits" type="number" min="0" value="${it.numberOfUnits}" placeholder="2" style="width:60px"/>
              </div>
            </td>
            <td class="muted" data-id-price="${it.id}">${formatMoney(calculatedPrice)}</td>
            <td><button class="btn ghost" data-delid="${it.id}">Delete</button></td>
          `;
          itemsTableBody.appendChild(tr);
        });

        // Add listeners for real-time updates
        itemsTableBody.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('input', e=>{
            const id = +e.target.dataset.id;
            const it = items.find(x=>x.id===id);
            if(!it) return;
            
            if(e.target.classList.contains('desc')) {
              it.desc = e.target.value;
            }
            if(e.target.classList.contains('unitPrice')) {
              it.unitPrice = e.target.value;
            }
            if(e.target.classList.contains('numberOfUnits')) {
              it.numberOfUnits = e.target.value;
            }
            if(e.target.classList.contains('unitType')) {
              it.unitType = e.target.value;
            }
            
            // Calculate price and update cells
            const calculatedPrice = (parseFloat(it.unitPrice) || 0) * (parseFloat(it.numberOfUnits) || 0);
            it.price = calculatedPrice;
            
            const priceCell = itemsTableBody.querySelector(`[data-id-price="${it.id}"]`);
            if(priceCell) priceCell.textContent = formatMoney(calculatedPrice);
            
            generatePreview();
            validateForm();
          });
        });
        
        itemsTableBody.querySelectorAll('button[data-delid]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const id = +e.target.dataset.delid;
            const idx = items.findIndex(x=>x.id===id);
            if(idx>-1) items.splice(idx,1);
            refreshItemsTable();
            generatePreview();
            validateForm();
          });
        });
      }
    }

    function validateForm() {
      const fromAddress = document.getElementById('fromAddress').value.trim();
      const toAddress = document.getElementById('toAddress').value.trim();
      const hasItems = items.length > 0;
      
      // Also check if items have values
      let itemsHaveValues = true;
      if (hasItems) {
        itemsHaveValues = items.some(item => 
          item.desc && item.desc.trim() !== '' && 
          item.unitPrice && item.unitPrice.toString().trim() !== '' && 
          item.numberOfUnits && item.numberOfUnits.toString().trim() !== ''
        );
      }
      
      let isValid = true;
      
      // Validate from address
      if (fromAddress === '') {
        document.getElementById('fromAddress').classList.add('validation-error');
        fromAddressError.style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('fromAddress').classList.remove('validation-error');
        fromAddressError.style.display = 'none';
      }
      
      // Validate to address
      if (toAddress === '') {
        document.getElementById('toAddress').classList.add('validation-error');
        toAddressError.style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('toAddress').classList.remove('validation-error');
        toAddressError.style.display = 'none';
      }
      
      // Validate items
      if (!hasItems || !itemsHaveValues) {
        itemsError.style.display = 'block';
        isValid = false;
      } else {
        itemsError.style.display = 'none';
      }
      
      // Enable/disable download button
      downloadPdfBtn.disabled = !isValid;
      
      return isValid;
    }

    addItemBtn.addEventListener('click', ()=>{addItem();});

    downloadPdfBtn.addEventListener('click', async () => {
      // Validate form before allowing download
      if (!validateForm()) {
        showStatus("Please fill all required fields", true);
        return;
      }
      
      // Show loading status
      showStatus("Generating PDF...");
      
      try {
        await generatePDF();
        showStatus("PDF downloaded successfully!");
      } catch (error) {
        console.error('PDF generation error:', error);
        showStatus("Error generating PDF. Please try again.", true);
      }
    });

    async function generatePDF() {
      return new Promise((resolve, reject) => {
        try {
          // Get the iframe content
          const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
          const invoiceElement = iframeDoc.querySelector('.inv');
          
          if (!invoiceElement) {
            reject(new Error('Invoice content not found'));
            return;
          }
          
          // Use html2canvas to capture the content
          html2canvas(invoiceElement, {
            scale: 2,
            useCORS: true,
            logging: false
          }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.98);
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Calculate dimensions to fit A4
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = 10;
            
            // Add image to PDF
            pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            
            // Save the PDF
            const type = document.getElementById('type').value;
            const number = document.getElementById('number').value;
            pdf.save(`${type}-${number}.pdf`);
            
            resolve();
          }).catch(reject);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    function formatMoney(v){
      const cur = document.getElementById('currency').value;
      const pos = document.getElementById('currencyPos').value;
      const symbolMap = {
        USD: '$', EUR: '€', GBP: '£', JPY: '¥', CAD: 'C$', AUD: 'A$', 
        CHF: 'CHF', CNY: '¥', INR: '₹', LKR: 'Rs', BRL: 'R$', RUB: '₽', 
        MXN: '$', SGD: 'S$', NZD: 'NZ$', SEK: 'kr', NOK: 'kr', DKK: 'kr', 
        ZAR: 'R', AED: 'د.إ'
      };
      const symbol = symbolMap[cur] || cur;
      const s = Number(v||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")
      return pos==='prefix' ? symbol + ' ' + s : s + ' ' + symbol;
    }

    function escapeHtml(s){ 
      return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
    }

    function generatePreview(){
      const from = document.getElementById('fromAddress').value;
      const to = document.getElementById('toAddress').value;
      const num = document.getElementById('number').value;
      const date = document.getElementById('date').value;
      const tax = parseFloat(document.getElementById('tax').value)||0;
      const discount = parseFloat(document.getElementById('discount').value)||0;
      const type = document.getElementById('type').value;

      // Calculate totals
      let sub = 0;
      items.forEach(it=>{ 
        const unitPrice = parseFloat(it.unitPrice) || 0;
        const numberOfUnits = parseFloat(it.numberOfUnits) || 0;
        const price = unitPrice * numberOfUnits;
        sub += price; 
      });
      const discAmount = sub * (discount/100);
      const taxed = (sub - discAmount) * (tax/100);
      const grand = sub - discAmount + taxed;

      // Build items HTML
      const rows = items.length > 0 ? 
        items.map(it=>{
          const unitPrice = parseFloat(it.unitPrice) || 0;
          const numberOfUnits = parseFloat(it.numberOfUnits) || 0;
          const price = unitPrice * numberOfUnits;
          const unitDisplay = it.unitType ? ` (${it.unitType})` : '';
          return `<tr>
            <td>${escapeHtml(it.desc || 'Item description')}</td>
            <td style="text-align:right">${formatMoney(unitPrice)}</td>
            <td style="text-align:right">${numberOfUnits}${unitDisplay}</td>
            <td style="text-align:right">${formatMoney(price)}</td>
          </tr>`;
        }).join('') : 
        `<tr><td colspan="4" style="text-align:center;color:#999;padding:20px">No items added</td></tr>`;

      // Frame HTML — optimized for A4 PDF
      const frameHtml = `
      <!doctype html>
      <html>
      <head>
        <meta charset="utf-8" />
        <title>${type==='invoice'?'INVOICE':'ESTIMATE'} - ${escapeHtml(num)}</title>
        <style>
          body {
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
            color: #111;
            background: #fff;
            margin: 0;
          }
          .inv {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #eee;
            padding: 25px;
            background: #fff;
            box-sizing: border-box;
          }
          header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
          }
          .company {
            font-weight: 700;
            font-size: 14px;
          }
          .small {
            color: #666;
            font-size: 12px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
          }
          th, td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
          }
          th {
            background: #fafafa;
            font-weight: bold;
          }
          .right {
            text-align: right;
          }
          .totals {
            margin-top: 20px;
            width: 100%;
            font-size: 12px;
          }
          .totals td {
            padding: 6px 8px;
          }
          .note {
            margin-top: 25px;
            font-size: 12px;
            color: #444;
            text-align: center;
          }
          @media print {
            body {
              background: #fff;
              margin: 0;
              padding: 0;
            }
            .inv {
              border: 0;
              padding: 15px;
              max-width: 100%;
            }
          }
        </style>
      </head>
      <body>
        <div class="inv">
          <header>
            <div>
              ${logoDataUrl?`<img src="${logoDataUrl}" style="max-height:60px; max-width:200px;">`:'<div style="height:60px;width:200px;display:flex;align-items:center;justify-content:center;border:1px dashed #ddd;color:#999;font-size:12px">No logo</div>'}
            </div>
            <div style="text-align:right">
              <div style="font-size:18px;font-weight:700">${type==='invoice'?'INVOICE':'ESTIMATE'}</div>
              <div class="small">Number: ${escapeHtml(num)}</div>
              <div class="small">Date: ${escapeHtml(date.replace('T',' '))}</div>
            </div>
          </header>

          <section style="display:flex;justify-content:space-between;margin-top:20px">
            <div style="width:48%">
              <div class="company">From</div>
              <pre class="small" style="white-space:pre-wrap; margin: 8px 0; font-family: inherit; font-size: 11px;">${escapeHtml(from || 'Your Company Name\n123 Business Street\nCity, State 12345')}</pre>
            </div>
            <div style="width:48%">
              <div class="company">To</div>
              <pre class="small" style="white-space:pre-wrap; margin: 8px 0; font-family: inherit; font-size: 11px;">${escapeHtml(to || 'Client Company Name\n456 Client Avenue\nCity, State 67890')}</pre>
            </div>
          </section>

          <table>
            <thead>
              <tr>
                <th style="width:40%">Description</th>
                <th style="text-align:right">Unit Price</th>
                <th style="text-align:right">Number of units</th>
                <th style="text-align:right">Price</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>

          <table class="totals" style="float:right;width:300px">
            <tr><td class="small">Subtotal</td><td class="right">${formatMoney(sub)}</td></tr>
            <tr><td class="small">Discount (${discount}%)</td><td class="right">${formatMoney(discAmount)}</td></tr>
            <tr><td class="small">Tax (${tax}%)</td><td class="right">${formatMoney(taxed)}</td></tr>
            <tr><td style="font-weight:700">Total</td><td style="font-weight:700;text-align:right">${formatMoney(grand)}</td></tr>
          </table>

          <div style="clear:both"></div>
          <div class="note">Thank you for your business.</div>
        </div>
      </body>
      </html>
      `;

      // Create blob URL and set iframe src
      const blob = new Blob([frameHtml], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      previewFrame.src = url;
      
      // Clean up the blob URL after the iframe loads
      previewFrame.onload = function() {
        URL.revokeObjectURL(url);
      };
    }

    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.style.background = isError ? '#e74c3c' : '#2ecc71';
      statusMessage.style.opacity = 1;
      
      setTimeout(() => {
        statusMessage.style.opacity = 0;
      }, 3000);
    }

    // Initial state - no items
    refreshItemsTable();
    generatePreview();
    validateForm();
  </script>
</body>
</html>